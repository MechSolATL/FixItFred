@page
@using MVP_Core.Models.Mobile
@model MVP_Core.Pages.Mobile.NextJobModel
@{
    int techId = 0;
    int.TryParse(Request.Query["techId"], out techId);
    var job = Model.Job;
    ViewData["Title"] = "My Next Job";
    /*
     * FixItFred Patch Log — Sprint 24.9 Recovery Patch R24.9R [2024-07-24T23:20:00Z]
     * Removed/commented Razor reference to 'media' at line 20 (variable or element).
    */
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        .mobile-panel { max-width: 420px; margin: 0 auto; padding: 1em; }
        .job-card { border-radius: 12px; box-shadow: 0 2px 8px #ccc; padding: 1em; background: #fff; }
        .job-label { font-weight: bold; color: #555; }
        .ping-btn { width: 100%; font-size: 1.2em; margin-top: 1em; }
        .note-block { background: #f8f9fa; border-radius: 8px; padding: 0.7em; margin-top: 1em; }
        @@media (max-width: 600px) { .mobile-panel { padding: 0.3em; } .job-card { padding: 0.5em; } }
    </style>
</head>
<body>
<div class="mobile-panel">
    <h3 class="mb-3">Technician Mobile Panel</h3>
    @if (job == null)
    {
        <div class="alert alert-warning">No active job assigned.</div>
    }
    else
    {
        <div class="job-card mb-3">
            <div class="mb-2 job-label">Technician:</div>
            <div class="mb-2">@job.TechnicianName</div>
            <div class="mb-2 job-label">Next Job:</div>
            <div class="mb-2">@job.JobSummary</div>
            <div class="mb-2 job-label">ETA:</div>
            <div class="mb-2">@job.ETA.ToLocalTime():t</div>
            <div class="mb-2 job-label">Countdown to ETA:</div>
            <div class="mb-2"><span id="countdown-timer"></span></div>
            <div class="progress mb-2" style="height: 18px;">
                <div id="progress-bar" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
            </div>
            <div class="mb-2 job-label">Address:</div>
            <div class="mb-2"><a href="https://maps.google.com/?q=@job.Address" target="_blank">@job.Address</a></div>
            <div class="mb-2 job-label">Last Dispatcher Note:</div>
            <div class="note-block">@job.DispatcherNote</div>
            <div class="mb-2 job-label">Last Ping:</div>
            <div class="mb-2">@job.LastPing.ToLocalTime():t</div>
            <form method="post">
                <input type="hidden" name="techId" value="@job.TechnicianId" />
                <button type="submit" class="btn btn-success ping-btn">Ping Dispatcher (I'm Ready)</button>
            </form>
            <a href="/Mobile/JobMessages?techId=@job.TechnicianId&requestId=1" class="btn btn-outline-primary w-100 mt-2">?? Messages</a>
            @if (TempData["PingStatus"] != null)
            {
                <div class="alert alert-success mt-2">@TempData["PingStatus"]</div>
            }
        </div>
        <script>
            // Countdown and progress bar logic
            (function() {
                var eta = new Date('@job.ETA.ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ssZ")');
                var now = new Date();
                var start = now;
                var end = eta;
                var total = (end - start) > 0 ? (end - start) : 1;
                function updateCountdown() {
                    now = new Date();
                    var diff = Math.max(0, end - now);
                    var mins = Math.floor(diff / 60000);
                    var secs = Math.floor((diff % 60000) / 1000);
                    document.getElementById('countdown-timer').textContent = mins + 'm ' + secs + 's';
                    var percent = 100 - Math.floor((diff / total) * 100);
                    document.getElementById('progress-bar').style.width = percent + '%';
                    if (diff > 0) setTimeout(updateCountdown, 1000);
                }
                updateCountdown();
            })();
        </script>
    }
    <div class="mt-4 text-center">
        <span class="text-muted">Scan QR to login (coming soon)</span>
    </div>
</div>
</body>
</html>
