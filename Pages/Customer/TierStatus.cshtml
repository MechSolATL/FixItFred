@page
@model MVP_Core.Pages.Customer.TierStatusModel
@inject MVP_Core.Services.CustomerPortalService PortalService
@inject MVP_Core.Services.RewardTriggerService RewardService
@{
    Layout = "/Pages/Shared/_Layout.cshtml";
    if (!(User.Identity?.IsAuthenticated == true) || !User.HasClaim("IsCustomer", "true"))
    {
        <div class="alert alert-danger">Access denied. Please log in as a customer.</div>
        return;
    }
    var email = User.Identity?.Name ?? string.Empty;
    var loyalty = PortalService.GetLoyaltyTransactions(email) ?? new List<MVP_Core.Data.Models.LoyaltyPointTransaction>();
    var tiers = PortalService.GetRewardTiers() ?? new List<MVP_Core.Data.Models.RewardTier>();
    var currentTier = tiers.LastOrDefault(t => loyalty.Sum(l => l.Points) >= t.PointsRequired);
    var nextTier = tiers.FirstOrDefault(t => t.PointsRequired > (loyalty.Sum(l => l.Points)));
    var totalPoints = loyalty.Sum(l => l.Points);
    var unlockedRewards = RewardService.GetUnlockedRewards(email) ?? new List<string>();
    var progressPercent = nextTier != null && nextTier.PointsRequired > 0 ? (int)(100.0 * totalPoints / nextTier.PointsRequired) : 100;
    bool hasBronze = currentTier != null && currentTier.PointsRequired >= (tiers.FirstOrDefault(t => t.Name == "Bronze")?.PointsRequired ?? 0);
}
@if (!hasBronze)
{
    <div class="alert alert-warning">Earn at least Bronze tier to view your status.</div>
    return;
}
<div class="container mx-auto px-2 py-4">
    <h2 class="mb-4">Your Tier Status</h2>
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card p-3 mb-2">
                <div class="fw-bold">Total Points</div>
                <div class="fs-2">@totalPoints</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card p-3 mb-2">
                <div class="fw-bold">Current Tier</div>
                <div class="fs-2">@currentTier?.Name ?? "None"</div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card p-3 mb-2">
                <div class="fw-bold">Next Tier</div>
                <div class="fs-2">@nextTier?.Name ?? "Max Tier"</div>
                @if (nextTier != null)
                {
                    <div class="text-muted">@((nextTier.PointsRequired - totalPoints)) points to next tier</div>
                }
            </div>
        </div>
    </div>
    <div class="mb-4">
        <label class="fw-bold">Progress to Next Tier</label>
        <div class="progress" style="height: 32px;">
            <div class="progress-bar bg-success" role="progressbar" style="width: @progressPercent%" aria-valuenow="@progressPercent" aria-valuemin="0" aria-valuemax="100">
                @progressPercent%
            </div>
        </div>
    </div>
    <div class="mb-4">
        <label class="fw-bold">Rewards Unlocked</label>
        <ul class="list-group">
        @foreach (var reward in unlockedRewards)
        {
            <li class="list-group-item">@reward</li>
        }
        </ul>
    </div>
</div>
