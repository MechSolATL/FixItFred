@using Services.Tenant
@inject TenantResolver TenantResolver
@{
    Layout = null;
    var deviceType = Context.Items["DeviceType"]?.ToString() ?? "Unknown";
    var isMobile = deviceType == "Mobile";
    ViewData["Title"] ??= "Service Atlanta";
    var branding = TenantResolver.TenantBranding;
    var modules = TenantResolver.TenantModules;
}

<!-- Offline Banner for ConnectivityMonitor.js -->
<div class="offline-banner" style="display:none;"></div>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Service Atlanta</title>
    <meta name="description" content="@ViewData["MetaDescription"]" />
    <meta name="keywords" content="@ViewData["Keywords"]" />
    <meta name="robots" content="@ViewData["Robots"]" />

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- Styles -->
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/MVP_Core.styles.css" asp-append-version="true" />

    <style>
        html, body {
            font-family: 'Poppins', sans-serif;
            background: url('/stream/background') no-repeat center center fixed;
            background-size: cover;
            min-height: 100%;
            margin: 0;
            padding: 0;
        }
        .navbar, .navbar-brand, .navbar-nav .nav-link, .navbar-light {
            background-color: @(branding?.PrimaryColor ?? "#007bff") !important;
        }
        .navbar-brand img {
            max-height: 48px;
            max-width: 160px;
        }
        .content-wrapper {
            background: rgba(255, 255, 255, 0.5);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            margin-top: 30px;
            margin-bottom: 30px;
        }
        h1, h2, h3 {
            font-weight: 700;
        }
        .btn {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            letter-spacing: 0.5px;
            border-radius: 0.5rem;
        }
        .form-control, .form-select {
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            border-radius: 0.5rem;
        }
        .save-status-chip {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 9999;
            padding: 6px 12px;
            border-radius: 16px;
            background: #28a745;
            color: #fff;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: none;
        }
        .save-status-chip.syncing {
            background: #007bff;
        }
    </style>

    <script src="~/js/MediaQueueHandler.js"></script>
    @if (!string.IsNullOrEmpty(branding?.FaviconUrl))
    {
        <link rel="icon" type="image/png" href="@branding.FaviconUrl" />
    }
    else
    {
        <link rel="icon" type="image/png" href="/favicon.ico" />
    }
</head>
<body>
    <!-- Header -->
    <header role="banner">
        <nav class="navbar navbar-expand-sm navbar-light border-bottom box-shadow mb-3">
            <div class="container">
                <a class="navbar-brand fw-bold" asp-area="" asp-page="/Index">
                    @if (!string.IsNullOrEmpty(branding?.LogoUrl))
                    {
                        <img src="@branding.LogoUrl" alt="Logo" />
                    }
                    else
                    {
                        <span>Service Atlanta</span>
                    }
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target=".navbar-collapse"
                        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="navbar-collapse collapse d-sm-inline-flex justify-content-between">
                    <ul class="navbar-nav flex-grow-1">
                        <li class="nav-item"><a class="nav-link text-dark" asp-area="" asp-page="/Index">Home</a></li>
                        <li class="nav-item"><a class="nav-link text-dark" asp-area="" asp-page="/Privacy">Privacy</a></li>
                        <li class="nav-item"><a class="nav-link text-dark" asp-page="/Services/Plumbing">Plumbing</a></li>
                        <li class="nav-item"><a class="nav-link text-dark" asp-page="/Technician/LeaderboardView">Technician Leaderboard</a></li>
                        <li class="nav-item"><a class="nav-link text-dark" asp-page="/TestSeoCompliance">Test SEO Compliance</a></li>
                        <li class="nav-item"><a class="nav-link text-dark" asp-page="/AccessDenied">Access Denied</a></li>
                        <li class="nav-item"><a class="nav-link text-dark" asp-page="/Customer/ServiceHistory">Service History</a></li>
                        @* Module Guards *@
                        @if (modules?.AccountingView == true)
                        {
                            <li class="nav-item"><a class="nav-link text-dark" asp-page="/Admin/Accounting">Accounting</a></li>
                        }
                    </ul>
                </div>
            </div>
        </nav>
        <!-- Microsoft Advertising UET Tag -->
        <script>
            (function(w,d,t,r,u){
              var f,n,i;
              w[u]=w[u]||[],
              f=function(){
                var o={ti:"343190833", enableAutoSpaTracking: true};
                o.q=w[u],w[u]=new UET(o),w[u].push("pageLoad")
              },
              n=d.createElement(t),n.src=r,n.async=1,n.onload=n.onreadystatechange=function(){
                var s=this.readyState;
                s && s!=="loaded" && s!=="complete" || (f(),n.onload=n.onreadystatechange=null)
              },
              i=d.getElementsByTagName(t)[0],i.parentNode.insertBefore(n,i)
            })(window,document,"script","//bat.bing.com/bat.js","uetq");
        </script>
    </header>

    <!-- Main Content -->
    <main role="main" class="container">
        <div class="content-wrapper">
            @RenderBody()
        </div>
    </main>

    <!-- Footer -->
    <footer class="text-center mt-5" style="font-size:8pt; color:white; background-color:rgba(0, 0, 0, 0.5); padding: 15px;" role="contentinfo">
        &copy; 1997–2025 <strong>Virtual Concepts</strong> for
        <a href="https://service-atlanta.com" target="_blank" style="color:white; text-decoration:underline;">service-atlanta.com</a> |
        <strong>Mechanical Solutions Atlanta</strong>. All rights reserved.
        <br />
        <a href="/AboutUs" style="color:white; text-decoration:underline;">About Us</a> &nbsp;|&nbsp;
        <a href="/Privacy" style="color:white; text-decoration:underline;">Privacy Policy</a> &nbsp;|&nbsp;
        <a href="/Legal/License" style="color:white; text-decoration:underline;">License</a> &nbsp;|&nbsp;
        <a href="/Legal/Terms" style="color:white; text-decoration:underline;">Terms</a>
    </footer>

    <!-- Scripts -->
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    <script src="~/js/ConnectivityMonitor.js" asp-append-version="true"></script>
    <script src="~/js/SaveStatusTracker.js"></script>
    @await RenderSectionAsync("Scripts", required: false)
    <!-- Disable Right-Click, Ctrl+U, F12 -->
    <script>
        document.addEventListener('contextmenu', e => e.preventDefault());
        document.addEventListener('keydown', e => {
            if (e.ctrlKey && ['u','U','s','S','p','P'].includes(e.key) ||
                e.key === 'F12' ||
                (e.ctrlKey && e.shiftKey && ['I','i'].includes(e.key))) {
                e.preventDefault();
            }
        });
    </script>
    <!-- Click Tracking -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            document.body.addEventListener('click', e => {
                const target = e.target.closest('button, a, input[type="submit"], input[type="button"]');
                if (!target) return;
                const clickedText = target.innerText?.trim() || target.getAttribute('aria-label') || target.getAttribute('alt');
                if (clickedText?.length > 1) {
                    fetch('/api/click-log', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            clickText: clickedText,
                            pageName: window.location.pathname
                        })
                    }).catch(err => console.error('Click log error:', err));
                }
            });
        });
    </script>
    @if (TempData["ToastMessage"] is string msg)
    {
        <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1100;">
            <div class="toast bg-success text-white show" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-body">@msg</div>
            </div>
        </div>
    }
    <div id="media-sync-chip" class="success" style="position:fixed;top:10px;right:10px;z-index:9999;padding:6px 12px;border-radius:16px;background:#eee;color:#333;font-weight:bold;box-shadow:0 2px 8px rgba(0,0,0,0.1);">0 pending media items</div>
    <div class="save-status-chip syncing" style="display:none;">?? Saving…</div>
</body>
</html>
