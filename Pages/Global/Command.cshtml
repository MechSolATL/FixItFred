@page
@model Pages.Global.CommandModel
@{
    ViewData["Title"] = "NovaGodView Command Console";
}
<div class="container-fluid px-4 py-4">
    <h2 class="mb-4">NovaGodView — Command Console</h2>
    <div class="row row-cols-1 row-cols-md-3 row-cols-lg-5 g-4">
        @foreach (var card in Model.Metrics)
        {
            @await Html.PartialAsync("/Pages/Shared/_MetricsCard.cshtml", card)
        }
    </div>
    <!-- Compliance Reminders Partial -->
    @if (Model.AlertSummary != null && Model.AlertSummary.Count > 0)
    {
        @await Html.PartialAsync("/Pages/Shared/_ComplianceReminderCard.cshtml", Model.AlertSummary)
    }
    <!-- Diagnostics AI Alerts Partial -->
    @if (Model.DiagnosticsAlerts != null && Model.DiagnosticsAlerts.Count > 0)
    {
        <div class="diagnostics-alerts-section my-4">
            <h4 class="mb-3"><i class="fas fa-robot text-primary"></i> AI Diagnostics Alerts</h4>
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                @foreach (var alert in Model.DiagnosticsAlerts)
                {
                    <div class="col">
                        @await Html.PartialAsync("/Pages/Shared/_DiagnosticsAlertCard.cshtml", alert)
                    </div>
                }
            </div>
        </div>
    }
    <!-- Decision Memory Partial -->
    @await Html.PartialAsync("/Pages/Shared/_DecisionMemorySummary.cshtml", Model.DecisionMemory)
    <div class="alert alert-danger compliance-lockout-alert my-4" style="display:@(Model.LockedOutTenants.Any() ? "block" : "none")">
        <b>Compliance Lockout:</b> The following tenants are locked out due to expired compliance documents:
        <ul>
            @foreach (var t in Model.LockedOutTenants)
            {
                <li>
                    <b>@t.CompanyName</b> (ID: @t.Id)
                    <button class="btn btn-warning btn-sm ms-2 override-lockout-btn" data-tenant-id="@t.Id" data-company="@t.CompanyName">Override Lockout</button>
                </li>
            }
        </ul>
    </div>
    <div id="overrideLockoutModal" class="modal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <form method="post" asp-page-handler="OverrideLockout">
                    <div class="modal-header">
                        <h5 class="modal-title">Override Lockout</h5>
                        <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="TenantId" id="modalTenantId" />
                        <div class="mb-3">
                            <label for="AdminNote" class="form-label">Reason for Override</label>
                            <textarea name="AdminNote" id="modalAdminNote" class="form-control" required></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-success">Submit Override</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="process-monitor-grid mt-5 mb-4">
        <h4 class="mb-3"><i class="fas fa-microchip text-info"></i> Process Monitor</h4>
        <div class="row row-cols-1 row-cols-md-3 row-cols-lg-5 g-4">
            @foreach (var proc in Model.ProcessStatuses)
            {
                <div class="col">
                    @await Html.PartialAsync("/Pages/Shared/_ProcessTile.cshtml", proc)
                </div>
            }
        </div>
    </div>
    @if (Model.Forecast != null)
    {
        <div class="forecast-display mt-5 p-4 rounded shadow-sm bg-white">
            <h4 class="mb-3"><i class="fas fa-chart-line text-primary"></i> Predictive Insights (Next 7 Days)</h4>
            <div class="row g-3">
                <div class="col-md-3 col-6">
                    <div class="forecast-metric">
                        <div class="forecast-label">Projected Requests</div>
                        <div class="forecast-value">@Model.Forecast.ProjectedRequests</div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="forecast-metric">
                        <div class="forecast-label">Avg. Delay (min)</div>
                        <div class="forecast-value">@Model.Forecast.AverageDelayMinutes</div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="forecast-metric">
                        <div class="forecast-label">Projected Revenue</div>
                        <div class="forecast-value text-success">$@Model.Forecast.ProjectedRevenue.ToString("N0")</div>
                    </div>
                </div>
                <div class="col-md-3 col-6">
                    <div class="forecast-metric">
                        <div class="forecast-label">Tech Gap</div>
                        <div class="forecast-value text-danger">@Model.Forecast.TechnicianGap</div>
                    </div>
                </div>
            </div>
        </div>
    }
    @if (Model.ProActions != null && Model.ProActions.Count > 0)
    {
        <div class="proaction-queue mt-5">
            <h4 class="mb-3"><i class="fas fa-bolt text-warning"></i> ProAction Queue</h4>
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                @foreach (var action in Model.ProActions)
                {
                    <div class="col">
                        @await Html.PartialAsync("/Pages/Shared/_ProActionCard.cshtml", action)
                    </div>
                }
            </div>
        </div>
    }
</div>
@section Scripts {
<script>
    document.querySelectorAll('.override-lockout-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.getElementById('modalTenantId').value = this.getAttribute('data-tenant-id');
            document.getElementById('overrideLockoutModal').style.display = 'block';
        });
    });
    document.querySelectorAll('.modal .close, .modal .btn-secondary').forEach(btn => {
        btn.addEventListener('click', function() {
            document.getElementById('overrideLockoutModal').style.display = 'none';
        });
    });
</script>
}
