@page
@* Sprint 26.5 Patch Log: Dynamic form flow cloned from Plumbing for Air Conditioning. Multi-step questions, progress bar, session, and SEO metadata. *@
@model MVP_Core.Pages.Services.AirConditioningModel
@inject MVP_Core.Services.ISeoService SeoService
@{
    Layout = "/Pages/Shared/_Layout.cshtml";
}
<head>
    @await Html.PartialAsync("/Pages/Shared/_SEOHead.cshtml")
</head>

@section Meta {
    <meta name="description" content="@ViewData["MetaDescription"]" />
    <meta name="keywords" content="@ViewData["Keywords"]" />
    <meta name="robots" content="@ViewData["Robots"]" />
}

<!-- ?? Session Timeout Warning -->
<div id="timeout-warning" class="hidden fixed top-0 left-0 w-full bg-red-600 text-white text-center py-2 font-bold z-50 animate-pulse" role="alert" aria-live="assertive">
    ?? Session expires in <span id="timeout-seconds">60</span> seconds! Click anywhere to stay active.
</div>

<!-- ?? Top Section: Title + Carousel -->
<div class="flex flex-col md:flex-row justify-between items-start gap-6 mb-6">
    <h1 class="text-2xl font-bold" role="heading" aria-level="1">
        Air Conditioning Service Request
    </h1>

    @if (Model?.CarouselImages?.Any() == true)
    {
        <div id="certificationCarousel" class="carousel slide max-w-md w-full md:w-96" data-bs-ride="carousel">
            <div class="carousel-inner rounded shadow border border-gray-300">
                @for (int i = 0; i < Model.CarouselImages.Count; i++)
                {
                    <div class="carousel-item @(i == 0 ? "active" : "")">
                        <img src="~/assets/@Model.CarouselImages[i]" class="d-block w-100" alt="Partner Image @(i + 1)">
                    </div>
                }
            </div>
            <button class="carousel-control-prev" type="button" data-bs-target="#certificationCarousel" data-bs-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Previous</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#certificationCarousel" data-bs-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Next</span>
            </button>
        </div>
    }
</div>

<!-- ?? Marketing Section -->
@if (!string.IsNullOrWhiteSpace(Model?.MarketingText))
{
    <div class="bg-blue-50 border-l-4 border-blue-400 text-blue-800 p-4 mb-6 rounded shadow-sm" role="region" aria-label="Marketing Text">
        <div class="whitespace-pre-wrap">
            @Model.MarketingText
        </div>
    </div>
}

<!-- ?? Progress Bar -->
@if (Model != null)
{
    <div class="progress-container mb-4">
        <div class="progress-bar bg-success" id="progressBar"
             style="width: @Model.ProgressPercent;"
             role="progressbar"
             aria-valuenow="@Model.CurrentStep"
             aria-valuemin="0"
             aria-valuemax="@Model.TotalQuestions">
            Step @Model.CurrentStep of @Model.TotalQuestions
        </div>
    </div>
}

<!-- ?? Alerts -->
@if (Model?.IsVerified == false)
{
    <div class="alert alert-warning p-4 text-yellow-800 border border-yellow-400 bg-yellow-100 rounded" role="alert">
        <strong>Email not verified.</strong><br />
        Please <a href="/Verify" class="underline text-blue-700 font-semibold">verify your email</a> before proceeding with the service request.
    </div>
}
else if (!string.IsNullOrEmpty(Model?.Message))
{
    <div class="mb-4 p-3 rounded @(Model.IsSuccess ? "bg-green-100 text-green-800" : "bg-red-100 text-red-800")" role="alert">
        @Model.Message
    </div>
}

<!-- ?? Question Form -->
@if (Model?.IsVerified == true && Model.CurrentQuestion != null)
{
    <form method="post" asp-page-handler="Next" class="space-y-4" aria-label="Air Conditioning Question Form">
        <partial name="_ValidationSummary" />
        @Html.AntiForgeryToken()

        <div>
            <label class="block text-gray-700 font-semibold mb-2">
                @(Model.FirstName != null ? $"{Model.FirstName}, " : "") @Model.CurrentQuestion.Text
            </label>

            @if (Model.CurrentQuestion.InputType == "dropdown" && Model.CurrentQuestion.Options != null)
            {
                <select asp-for="UserAnswer" class="form-control" required>
                    <option value="">-- Select --</option>
                    @foreach (var option in Model.CurrentQuestion.Options)
                    {
                        <option value="@option.OptionText">@option.OptionText</option>
                    }
                </select>
                <span asp-validation-for="UserAnswer" class="text-danger"></span>
                <span class="form-text text-muted">Select the most accurate option for your air conditioning issue.</span>
            }
            else if (Model.CurrentQuestion.InputType == "textarea")
            {
                <textarea asp-for="UserAnswer" rows="4" class="form-control" maxlength="500" required></textarea>
                <span asp-validation-for="UserAnswer" class="text-danger"></span>
                <span class="form-text text-muted">Describe your air conditioning issue in detail.</span>
            }
            else
            {
                <input type="text" asp-for="UserAnswer" class="form-control" maxlength="500" required />
                <span asp-validation-for="UserAnswer" class="text-danger"></span>
                <span class="form-text text-muted">Enter details about your air conditioning problem.</span>
            }
        </div>

        <input type="hidden" name="questionId" value="@Model.CurrentQuestion.Id" />

        <div class="flex justify-between mt-6">
            <button type="submit" class="btn btn-primary">?? Next</button>
            <partial name="_LoadingSpinner" />
        </div>
    </form>

    @if (Model.CurrentStep > 1)
    {
        <form method="post" asp-page-handler="Back" class="inline-block mt-4">
            @Html.AntiForgeryToken()
            <button type="submit" class="btn btn-secondary">?? Back</button>
        </form>
    }
}
else if (Model?.IsVerified == true && Model.CurrentQuestion == null)
{
    <div class="text-center mt-10" role="region" aria-label="Form Completed">
        <h2 class="text-2xl font-semibold text-green-700 mb-4">
            ?? Air Conditioning Questionnaire Completed!
        </h2>
        <p class="text-gray-700 mb-6">Please review your answers and submit your request.</p>
        <a href="/Services/AirConditioningFinal" class="inline-block px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded shadow">
            Review and Submit ??
        </a>
    </div>
}

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}
