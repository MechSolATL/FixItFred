@page
@model Pages.Technician.ProfileModel
@inject Services.Admin.RewardTriggerService RewardTriggerService
@inject Services.BadgeAssignmentService BadgeAssignmentService
@using Data.Models.PatchAnalytics
@{
    ViewData["Title"] = "Technician Profile";
    var tierStatus = Model.TierStatus;
    var patchProfile = Model.PatchProfile;
    var banterFlagCount = Model.BanterFlagCount;
    // Sprint 91.22.4 - BadgeAssignment: Load badges for this technician
    var badges = BadgeAssignmentService.GetBadgesForTechnicianAsync(patchProfile?.Id ?? 0).GetAwaiter().GetResult();
    var patchFav = badges.FirstOrDefault(b => b.BadgeType == "PatchFav");
}
<h2>Technician Profile</h2>
@if (tierStatus != null)
{
    <div class="card mb-3">
        <div class="card-body">
            <h4>@tierStatus.TechnicianName</h4>
            <span class="badge bg-info">Tier: @tierStatus.CurrentTier</span>
            <span class="badge bg-success">Points: @tierStatus.TotalPoints</span>
            <span class="badge bg-warning">Last Reward: @(tierStatus.LastRewardSentAt?.ToLocalTime().ToString("g") ?? "Never")</span>
            @if (tierStatus.IsEligibleForReward)
            {
                <span class="badge bg-primary">Eligible for Reward!</span>
            }
            else
            {
                <span class="badge bg-secondary">Not Eligible</span>
            }
        </div>
    </div>
}

@if (patchProfile != null)
{
    <div class="card mb-3">
        <div class="card-body">
            <h4>@patchProfile.FullName</h4>
            <span class="badge bg-info">Jobs: @patchProfile.CompletedJobs</span>
            <span class="badge bg-success">Close Rate: @patchProfile.CloseRate:P0</span>
        </div>
    </div>
    <!-- Sprint 91.22.4 - BadgeAssignment: Badge grid -->
    @if (badges.Any())
    {
        <div class="card mb-3">
            <div class="card-header">Badges</div>
            <div class="card-body">
                <div class="row row-cols-2 row-cols-md-4 g-3">
                    @foreach (var badge in badges)
                    {
                        <div class="col text-center">
                            <img src="@badge.IconPath" alt="@badge.BadgeType" title="@badge.Description (Earned: @badge.EarnedOn.ToShortDateString())" style="width:64px;height:64px;" class="mb-1" />
                            <div class="small">@badge.BadgeType</div>
                        </div>
                    }
                </div>
            </div>
        </div>
    }
    <!-- PatchFav quote if present -->
    @if (patchFav != null)
    {
        <div class="alert alert-info">?? <strong>Patch Quote:</strong> @patchFav.Description</div>
    }
    <div class="card mb-3">
        <div class="card-header">Patch Identity</div>
        <div class="card-body">
            <form method="post">
                <div class="mb-2">
                    <label for="Nickname">Nickname</label>
                    <input asp-for="Nickname" class="form-control" maxlength="40" />
                </div>
                <div class="form-check mb-2">
                    <input asp-for="EnableBanterMode" class="form-check-input" />
                    <label class="form-check-label" for="EnableBanterMode">Enable Banter Mode</label>
                </div>
                <button type="submit" class="btn btn-primary">Save</button>
            </form>
            @if (!string.IsNullOrEmpty(Model.PatchIdentityError))
            {
                <div class="alert alert-danger mt-2">@Model.PatchIdentityError</div>
            }
            @if (banterFlagCount >= 3)
            {
                <div class="alert alert-warning mt-2">Patch banter is temporarily muted due to repeated compliance issues.</div>
            }
            <div class="mt-3">
                <strong>Patch Preview:</strong>
                <div class="border rounded p-2 bg-light">@Model.PatchPreview</div>
            </div>
        </div>
    </div>
}
else
{
    <div class="alert alert-warning">Profile not found.</div>
}
<!-- Existing profile content below -->
@* ...existing code... *@
