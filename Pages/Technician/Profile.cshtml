@page
@model MVP_Core.Pages.Technician.ProfileModel
@inject MVP_Core.Services.Admin.RewardTriggerService RewardTriggerService
@{
    ViewData["Title"] = "Technician Profile";
    var tierStatus = Model.TierStatus;
    var patchProfile = Model.PatchProfile;
    var banterFlagCount = Model.BanterFlagCount;
}
<h2>Technician Profile</h2>
@if (tierStatus != null)
{
    <div class="card mb-3">
        <div class="card-body">
            <h4>@tierStatus.TechnicianName</h4>
            <span class="badge bg-info">Tier: @tierStatus.CurrentTier</span>
            <span class="badge bg-success">Points: @tierStatus.TotalPoints</span>
            <span class="badge bg-warning">Last Reward: @(tierStatus.LastRewardSentAt?.ToLocalTime().ToString("g") ?? "Never")</span>
            @if (tierStatus.IsEligibleForReward)
            {
                <span class="badge bg-primary">Eligible for Reward!</span>
            }
            else
            {
                <span class="badge bg-secondary">Not Eligible</span>
            }
        </div>
    </div>
}

@if (patchProfile != null)
{
    <div class="card mb-3">
        <div class="card-body">
            <h4>@patchProfile.FullName</h4>
            <span class="badge bg-info">Jobs: @patchProfile.CompletedJobs</span>
            <span class="badge bg-success">Close Rate: @patchProfile.CloseRate:P0</span>
        </div>
    </div>
    <div class="card mb-3">
        <div class="card-header">Patch Identity</div>
        <div class="card-body">
            <form method="post">
                <div class="mb-2">
                    <label for="Nickname">Nickname</label>
                    <input asp-for="Nickname" class="form-control" maxlength="40" />
                </div>
                <div class="form-check mb-2">
                    <input asp-for="EnableBanterMode" class="form-check-input" />
                    <label class="form-check-label" for="EnableBanterMode">Enable Banter Mode</label>
                </div>
                <button type="submit" class="btn btn-primary">Save</button>
            </form>
            @if (!string.IsNullOrEmpty(Model.PatchIdentityError))
            {
                <div class="alert alert-danger mt-2">@Model.PatchIdentityError</div>
            }
            @if (banterFlagCount >= 3)
            {
                <div class="alert alert-warning mt-2">Patch banter is temporarily muted due to repeated compliance issues.</div>
            }
            <div class="mt-3">
                <strong>Patch Preview:</strong>
                <div class="border rounded p-2 bg-light">@Model.PatchPreview</div>
            </div>
        </div>
    </div>
}
else
{
    <div class="alert alert-warning">Profile not found.</div>
}
<!-- Existing profile content below -->
@* ...existing code... *@
