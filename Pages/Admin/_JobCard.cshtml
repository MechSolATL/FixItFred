@model MVP_Core.Data.Models.ServiceRequest
@inject MVP_Core.Pages.Admin.DispatcherModel DispatcherModel
@{
    DateTime now = DateTime.UtcNow;
    string badgeClass = "bg-secondary";
    string badgeText = "No deadline";
    bool blink = false;
    if (Model.DueDate.HasValue)
    {
        var diff = Model.DueDate.Value - now;
        if (diff.TotalSeconds < 0)
        {
            badgeClass = "bg-danger text-white";
            badgeText = "Overdue";
            blink = true;
        }
        else if (diff.TotalHours < 4)
        {
            badgeClass = "bg-warning text-dark";
            badgeText = $"Due in {diff.Hours}h {diff.Minutes}m";
        }
        else
        {
            badgeClass = "bg-success text-white";
            badgeText = $"Due {Model.DueDate.Value.ToLocalTime():g}";
        }
    }
}
<div class="job-card mb-3 p-3 border rounded shadow-sm">
    <div class="d-flex justify-content-between align-items-center mb-2">
        <div>
            <span class="badge @DispatcherModel.GetStatusBadgeClass(DispatcherModel.TechnicianStatuses.TryGetValue(Model.Id, out var s) ? s : "Unassigned")">
                @(DispatcherModel.TechnicianStatuses.TryGetValue(Model.Id, out var status) ? status : "Unassigned")
            </span>
            <span class="ms-2">#@Model.Id</span>
        </div>
        <div class="priority-controls">
            <form method="post" asp-page-handler="MoveUp" class="d-inline">
                <input type="hidden" name="Index" value="@Model.Id" />
                <button type="submit" class="btn btn-link p-0" title="Increase Priority"><i class="fas fa-arrow-up"></i></button>
            </form>
            <form method="post" asp-page-handler="MoveDown" class="d-inline">
                <input type="hidden" name="Index" value="@Model.Id" />
                <button type="submit" class="btn btn-link p-0" title="Decrease Priority"><i class="fas fa-arrow-down"></i></button>
            </form>
        </div>
    </div>
    <div class="mb-2">
        <strong>@Model.CustomerName</strong> <span class="text-muted small">@Model.Email</span><br />
        <span class="text-secondary">@Model.ServiceType</span>
    </div>
    <div class="mb-2">
        <span class="me-2"><i class="fas fa-clock"></i> @Model.CreatedAt.ToLocalTime().ToString("g")</span>
        <span><i class="fas fa-map-marker-alt"></i> @Model.Address</span>
    </div>
    <div class="mb-2">
        <span class="badge @badgeClass @(blink ? "sla-blink" : "")" style="min-width:120px;">@badgeText</span>
        @if (Model.DueDate.HasValue)
        {
            <span class="text-muted small ms-2">(SLA)</span>
        }
        @if (Model.IsEscalated)
        {
            <span class="badge bg-danger ms-2">Escalated</span>
        }
    </div>
    <div class="mb-2">
        @if (Model.AssignedTechnicianId != null)
        {
            <span>
                <a href="#" class="tech-profile-link" data-tech-id="@Model.AssignedTechnicianId" onclick="openTechProfileModal(@Model.AssignedTechnicianId); return false;">
                    <i class="fas fa-user"></i> Technician: @DispatcherModel.TechnicianLoads.FirstOrDefault(t => t.Id == Model.AssignedTechnicianId)?.FullName
                </a>
            </span>
        }
    </div>
    <div class="d-flex flex-wrap gap-2 mt-2">
        <form method="post" asp-page-handler="AssignTechnician">
            <input type="hidden" name="RequestId" value="@Model.Id" />
            <button type="submit" class="btn btn-sm btn-success">Assign</button>
        </form>
        <form method="post" asp-page-handler="ShowMap">
            <input type="hidden" name="RequestId" value="@Model.Id" />
            <button type="submit" class="btn btn-sm btn-outline-primary">Map</button>
        </form>
        <form method="post" asp-page-handler="Reassign">
            <input type="hidden" name="RequestId" value="@Model.Id" />
            <button class="btn btn-sm btn-link" type="submit">Reassign</button>
        </form>
        <form method="post" asp-page-handler="Cancel">
            <input type="hidden" name="RequestId" value="@Model.Id" />
            <button class="btn btn-sm btn-link text-danger" type="submit">Cancel</button>
        </form>
        <form method="post" asp-page-handler="Escalate">
            <input type="hidden" name="RequestId" value="@Model.Id" />
            <button class="btn btn-sm btn-warning" type="submit">Escalate</button>
        </form>
        <a class="btn btn-sm btn-link" href="/admin/customer/@Model.Id">Profile</a>
    </div>
</div>
<style>
.sla-blink {
    animation: sla-blink 1s linear infinite;
}
keyframes sla-blink {
    0% { opacity: 1; }
    50% { opacity: 0.3; }
    100% { opacity: 1; }
}
</style>
