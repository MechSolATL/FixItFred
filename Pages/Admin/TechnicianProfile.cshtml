@page
@using MVP_Core.Models.Admin
@inject MVP_Core.Services.Admin.DispatcherService DispatcherService
@inject MVP_Core.Services.TechnicianFeedbackService FeedbackService
@model MVP_Core.Pages.Admin.TechnicianProfileModel
@{
    int techId = Model.TechId;
    var profile = Model.Profile;
    ViewData["Title"] = "Technician Profile";
}
<h2 class="mb-4">Technician Profile</h2>
@if (profile == null)
{
    <div class="alert alert-danger">Technician not found.</div>
}
else
{
    <div class="card mb-4">
        <div class="card-body">
            <h4>@profile.Name</h4>
            <div class="mb-2">
                <strong>Status:</strong>
                @if ((DateTime.UtcNow - profile.LastActive).TotalMinutes < 10)
                {
                    <span class="badge bg-success">?? Online</span>
                }
                else
                {
                    <span class="badge bg-danger">?? Offline</span>
                }
            </div>
            <div class="mb-2"><strong>Last Active:</strong> @profile.LastActive.ToLocalTime().ToString("hh:mm tt")</div>
            <div class="mb-2"><strong>Close Rate (7d):</strong> @profile.CloseRate7Days:P0</div>
            <div class="mb-2"><strong>Close Rate (30d):</strong> @profile.CloseRate30Days:P0</div>
            <div class="mb-2"><strong>Callbacks (7d):</strong> @profile.CallbackCount7Days</div>
            <div class="mb-2"><strong>Total Jobs (30d):</strong> @profile.TotalJobsLast30Days</div>
            <div class="mb-2"><strong>Top ZIPs:</strong> @string.Join(", ", profile.TopZIPs)</div>
        </div>
    </div>
    <div class="mb-4">
        <h5>Zone Heatmap (ZIP)</h5>
        <div class="border p-3 bg-light">[ZIP Heatmap Placeholder]</div>
    </div>
    <div class="mb-4">
        <h5>Comments & Notes</h5>
        @if (profile.Comments == null || !profile.Comments.Any())
        {
            <div class="alert alert-info">No comments available yet.</div>
        }
        else
        {
            <ul class="list-group">
            @foreach (var note in profile.Comments)
            {
                <li class="list-group-item">@note</li>
            }
            </ul>
        }
    </div>
    <div class="mb-4">
        <h5>Skill Tags</h5>
        @if (profile.SkillTags == null || !profile.SkillTags.Any())
        {
            <div class="alert alert-info">No skill tags assigned.</div>
        }
        else
        {
            <div>
                @foreach (var tag in profile.SkillTags)
                {
                    <span class="badge bg-secondary me-2">@tag <button class="btn btn-sm btn-link text-danger" title="Remove" style="padding:0;" onclick="removeTag('@tag')">?</button></span>
                }
            </div>
        }
        <form method="post" class="mt-3">
            <div class="input-group">
                <input type="text" name="newTag" class="form-control" placeholder="Add skill tag..." />
                <button type="submit" class="btn btn-outline-primary">Add Tag</button>
            </div>
        </form>
    </div>
    <div class="mb-4">
        <h5>Feedback & Ratings</h5>
        @{
            double avg = Model.AvgFeedback;
            var reviews = Model.RecentReviews;
        }
        @if (avg > 0)
        {
            <div class="mb-2"><strong>Score:</strong> <span class="badge bg-success">@avg</span></div>
            <ul class="list-group mb-2">
            @foreach (var fb in reviews)
            {
                <li class="list-group-item">@fb.Rating ? — @fb.Notes</li>
            }
            </ul>
        }
        else
        {
            <div class="alert alert-info">No feedback yet.</div>
        }
        <a href="/Admin/SubmitFeedback?techId=@profile.TechnicianId" class="btn btn-outline-warning">? Submit Feedback</a>
    </div>
    <div class="mb-4">
        <a href="/Admin/UploadMedia?techId=@profile.TechnicianId" class="btn btn-outline-primary me-2">?? Upload Media</a>
        <a href="/Admin/ViewMedia?techId=@profile.TechnicianId" class="btn btn-outline-secondary">?? View Media Vault</a>
    </div>
}

<script>
function removeTag(tag) {
    // Stub: Would call API to remove tag
    alert('Remove tag: ' + tag);
}
</script>
