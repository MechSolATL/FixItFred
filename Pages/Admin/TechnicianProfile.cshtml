@page
@using MVP_Core.Models.Admin
@inject MVP_Core.Services.Admin.DispatcherService DispatcherService
@inject MVP_Core.Services.TechnicianFeedbackService FeedbackService
@inject MVP_Core.Services.CertificationService CertService
@inject MVP_Core.Services.TechnicianPayService PayService
@inject MVP_Core.Services.TechnicianBonusService BonusService
@model MVP_Core.Pages.Admin.TechnicianProfileModel
@{
    int techId = Model.TechId;
    var profile = Model.Profile;
    ViewData["Title"] = "Technician Profile";
    var certs = CertService.GetCertifications(techId);
    var badges = Model.SkillBadges ?? new List<SkillBadge>();
    var payHistory = User.IsInRole("Admin") ? PayService.GetPayHistory(techId) : new List<TechnicianPayRecord>();
    var bonusHistory = Model.BonusHistory;
}
<h2 class="mb-4">Technician Profile</h2>
@if (profile == null)
{
    <div class="alert alert-danger">Technician not found.</div>
}
else
{
    <div class="card mb-4">
        <div class="card-body">
            <h4>@profile.Name</h4>
            <div class="mb-2">
                <strong>Status:</strong>
                @if ((DateTime.UtcNow - profile.LastActive).TotalMinutes < 10)
                {
                    <span class="badge bg-success">?? Online</span>
                }
                else
                {
                    <span class="badge bg-danger">?? Offline</span>
                }
            </div>
            <div class="mb-2"><strong>Last Active:</strong> @profile.LastActive.ToLocalTime().ToString("hh:mm tt")</div>
            <div class="mb-2"><strong>Close Rate (7d):</strong> @profile.CloseRate7Days:P0</div>
            <div class="mb-2"><strong>Close Rate (30d):</strong> @profile.CloseRate30Days:P0</div>
            <div class="mb-2"><strong>Callbacks (7d):</strong> @profile.CallbackCount7Days</div>
            <div class="mb-2"><strong>Total Jobs (30d):</strong> @profile.TotalJobsLast30Days</div>
            <div class="mb-2"><strong>Top ZIPs:</strong> @string.Join(", ", profile.TopZIPs)</div>
        </div>
    </div>
    <div class="mb-4">
        <h5>Zone Heatmap (ZIP)</h5>
        <div class="border p-3 bg-light">[ZIP Heatmap Placeholder]</div>
    </div>
    <div class="mb-4">
        <h5>Comments & Notes</h5>
        @if (profile.Comments == null || !profile.Comments.Any())
        {
            <div class="alert alert-info">No comments available yet.</div>
        }
        else
        {
            <ul class="list-group">
            @foreach (var note in profile.Comments)
            {
                <li class="list-group-item">@note</li>
            }
            </ul>
        }
    </div>
    <div class="mb-4">
        <h5>Skill Tags</h5>
        @if (profile.SkillTags == null || !profile.SkillTags.Any())
        {
            <div class="alert alert-info">No skill tags assigned.</div>
        }
        else
        {
            <div>
                @foreach (var tag in profile.SkillTags)
                {
                    <span class="badge bg-secondary me-2">@tag <button class="btn btn-sm btn-link text-danger" title="Remove" style="padding:0;" onclick="removeTag('@tag')">?</button></span>
                }
            </div>
        }
        <form method="post" class="mt-3">
            <div class="input-group">
                <input type="text" name="newTag" class="form-control" placeholder="Add skill tag..." />
                <button type="submit" class="btn btn-outline-primary">Add Tag</button>
            </div>
        </form>
    </div>
    <div class="mb-4">
        <h5>Feedback & Ratings</h5>
        @{
            double avg = Model.AvgFeedback;
            var reviews = Model.RecentReviews;
        }
        @if (avg > 0)
        {
            <div class="mb-2"><strong>Score:</strong> <span class="badge bg-success">@avg</span></div>
            <ul class="list-group mb-2">
            @foreach (var fb in reviews)
            {
                <li class="list-group-item">@fb.Rating ? — @fb.Notes</li>
            }
            </ul>
        }
        else
        {
            <div class="alert alert-info">No feedback yet.</div>
        }
        <a href="/Admin/SubmitFeedback?techId=@profile.TechnicianId" class="btn btn-outline-warning">? Submit Feedback</a>
    </div>
    <div class="mb-4">
        <a href="/Admin/UploadMedia?techId=@profile.TechnicianId" class="btn btn-outline-primary me-2">?? Upload Media</a>
        <a href="/Admin/ViewMedia?techId=@profile.TechnicianId" class="btn btn-outline-secondary">?? View Media Vault</a>
    </div>
    <div class="row mb-3">
        <div class="col-md-6">
            <h4>Certifications</h4>
            <ul class="list-group">
            @foreach (var cert in certs)
            {
                <li class="list-group-item @(cert.IsExpired ? "list-group-item-danger" : "")">
                    <strong>@cert.CertificationName</strong>
                    @if (cert.IsVerified)
                    {
                        <span class="badge bg-success ms-2">Verified</span>
                    }
                    else if (cert.IsExpired)
                    {
                        <span class="badge bg-danger ms-2">Expired</span>
                    }
                    else
                    {
                        <span class="badge bg-warning ms-2">Pending</span>
                    }
                    @if (!string.IsNullOrEmpty(cert.DocumentPath))
                    {
                        <a href="@cert.DocumentPath" target="_blank" class="ms-2">View</a>
                    }
                </li>
            }
            </ul>
        </div>
        <div class="col-md-6">
            <h4>Skill Badges</h4>
            <div>
            @foreach (var badge in badges)
            {
                <span class="me-2">
                    <img src="@badge.IconPath" alt="@badge.SkillName" style="height:32px;" title="@badge.SkillName" />
                    <span>@badge.SkillName</span>
                </span>
            }
            </div>
        </div>
    </div>
    @if (payHistory.Count > 0)
    {
        <div class="mt-4">
            <h4>Earnings Summary</h4>
            <table class="table table-sm">
                <thead>
                    <tr><th>Period</th><th>Total Pay</th><th>Type</th></tr>
                </thead>
                <tbody>
                @foreach (var pay in payHistory)
                {
                    <tr>
                        <td>@pay.PeriodStart.ToShortDateString() - @pay.PeriodEnd.ToShortDateString()</td>
                        <td>@pay.TotalPay</td>
                        <td>@pay.PayType</td>
                    </tr>
                }
                </tbody>
            </table>
        </div>
    }
    @if (bonusHistory.Count > 0)
    {
        <div class="mt-4">
            <h4>Bonus Log</h4>
            <table class="table table-sm">
                <thead>
                    <tr><th>Date</th><th>Type</th><th>Amount</th><th>Source Job</th><th>Reason</th></tr>
                </thead>
                <tbody>
                @foreach (var bonus in bonusHistory)
                {
                    <tr>
                        <td>@bonus.AwardedAt.ToShortDateString()</td>
                        <td>@bonus.BonusType</td>
                        <td>$@bonus.Amount</td>
                        <td>@bonus.SourceJobId</td>
                        <td>@bonus.ReasonNote</td>
                    </tr>
                }
                </tbody>
            </table>
        </div>
    }
}

<script>
function removeTag(tag) {
    // Stub: Would call API to remove tag
    alert('Remove tag: ' + tag);
}
</script>
