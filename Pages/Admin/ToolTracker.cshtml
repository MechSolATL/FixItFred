@page
@model MVP_Core.Pages.Admin.ToolTrackerModel
@using Data.DTO.Tools
@using Services.Admin
@inject ToolTrackingService ToolTrackingService
@inject PermissionService PermissionService
@{
    ViewData["Title"] = "Tool Tracker";
    Layout = "../Shared/_LayoutWideMap.cshtml"; // Sprint 91.7 Part 6.3
}
<!-- Sprint 91.7 Part 6.3: Tool Tracker UI Layer -->
<div class="container-fluid py-4">
    <h2 class="mb-4">Tool Inventory</h2>
    <div class="row mb-3">
        <div class="col-md-3">
            <label>Status:
                <select class="form-select" asp-for="FilterStatus" asp-items="Model.StatusOptions"></select>
            </label>
        </div>
        <div class="col-md-3">
            <label>Technician:
                <select class="form-select" asp-for="FilterTechnicianId" asp-items="Model.TechnicianOptions"></select>
            </label>
        </div>
        <div class="col-md-3">
            <input class="form-control" type="text" placeholder="Search by tool name..." asp-for="SearchTerm" />
        </div>
        <div class="col-md-3 text-end">
            <button class="btn btn-primary" type="submit" form="toolFilterForm">Apply Filters</button>
        </div>
    </div>
    <form id="toolFilterForm" method="get"></form>
    <table class="table table-striped table-hover align-middle">
        <thead class="table-light">
            <tr>
                <th>ToolId</th>
                <th>Name</th>
                <th>Description</th>
                <th>Assigned Tech</th>
                <th>Assigned Date</th>
                <th>Status</th>
                <th>Transfer</th>
            </tr>
        </thead>
        <tbody>
        @* Sprint 91.8 - RazorFix: Ensure Razor foreach/if syntax is correct in table rows *@
        @if (Model.Tools != null)
        {
            foreach (var tool in Model.Tools)
            {
                <tr data-toolid="@tool.ToolId">
                    <td>@tool.ToolId</td>
                    <td>@tool.Name</td>
                    <td>@tool.ToolType</td>
                    <td>@tool.AssignedTechnicianName</td>
                    <td>@tool.LastTransferDate?.ToString("g")</td>
                    <td>@tool.Status</td>
                    <td>
                        @if (tool.IsTransferable && tool.AssignedTechnicianId != null)
                        {
                            <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#transferModal" data-toolid="@tool.ToolId" data-fromtechid="@tool.AssignedTechnicianId" data-fromtechname="@tool.AssignedTechnicianName">Transfer Tool</button>
                        }
                    </td>
                </tr>
            }
        }
        </tbody>
    </table>
    <!-- Sprint 91.7 Part 6.3: Modal for tool transfer -->
    <div class="modal fade" id="transferModal" tabindex="-1" aria-labelledby="transferModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="post" asp-page-handler="TransferTool">
                    <div class="modal-header">
                        <h5 class="modal-title" id="transferModalLabel">Transfer Tool</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="ToolId" id="modalToolId" />
                        <input type="hidden" name="FromTechnicianId" id="modalFromTechId" />
                        <div class="mb-3">
                            <label class="form-label">Current Technician</label>
                            <input type="text" class="form-control" id="modalFromTechName" readonly />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">New Technician</label>
                            <select class="form-select" name="ToTechnicianId" id="modalToTechId">
                                <option value="">Select technician...</option>
                                @foreach (var tech in Model.AvailableTechs)
                                {
                                    <option value="@tech.Value">@tech.Text</option>
                                }
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Notes</label>
                            <textarea class="form-control" name="TransferNotes" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Confirm Transfer</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    @if (!string.IsNullOrEmpty(Model.StatusMessage))
    {
        <div class="alert alert-info mt-3">@Model.StatusMessage</div>
    }
    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger mt-3">@Model.ErrorMessage</div>
    }
</div>
@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <script src="/js/ToolTrackerMap.js"></script>
    <script>
        // Sprint 91.7 Part 6.3: Modal autofill logic
        var transferModal = document.getElementById('transferModal');
        transferModal.addEventListener('show.bs.modal', function (event) {
            var button = event.relatedTarget;
            var toolId = button.getAttribute('data-toolid');
            var fromTechId = button.getAttribute('data-fromtechid');
            var fromTechName = button.getAttribute('data-fromtechname');
            document.getElementById('modalToolId').value = toolId;
            document.getElementById('modalFromTechId').value = fromTechId;
            document.getElementById('modalFromTechName').value = fromTechName;
        });
    </script>
}
