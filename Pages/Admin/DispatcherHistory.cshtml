@page
// FixItFred Patch Log: Corrected invalid reference to 'to' at line 67. All loop/variable references now valid DTOs.
@using MVP_Core.Models.Admin
@inject MVP_Core.Services.Admin.DispatcherService DispatcherService
@model MVP_Core.Pages.Admin.DispatcherHistoryModel
@{
    int requestId = 0;
    int.TryParse(Request.Query["requestId"], out requestId);
    var timeline = DispatcherService.GetTimelineForRequest(requestId);
    var requestList = ViewData["RequestDetails"] as List<RequestSummaryDto> ?? new List<RequestSummaryDto>();
    var request = requestList.FirstOrDefault(r => r.Id == requestId);
    ViewData["Title"] = "Service Request Timeline";
}
<h2 class="mb-4">Service Request Timeline</h2>
@if (request == null)
{
    <div class="alert alert-danger">Invalid or missing request.</div>
}
else
{
    <div class="card mb-4">
        <div class="card-body">
            <strong>ID:</strong> @request.Id<br />
            <strong>Status:</strong> @request.Status<br />
            <strong>Technician:</strong> @request.Technician<br />
            <strong>Emergency:</strong> @(request.IsEmergency ? "?? Yes" : "No")<br />
        </div>
    </div>
    <h4>Timeline</h4>
    @if (timeline == null || !timeline.Any())
    {
        <div class="alert alert-info">No timeline activity recorded yet.</div>
    }
    else
    {
        <ul class="timeline list-unstyled">
            @foreach (var entry in timeline)
            {
                var icon = entry.ActionType switch
                {
                    "Assigned" => "??",
                    "Reassign" => "??",
                    "Override-Emergency" => "??",
                    "ETAOverride" => "?",
                    "Cancel" => "?",
                    "Escalate" => "??",
                    _ => "•"
                };
                <li class="mb-3">
                    <span class="me-2">@icon</span>
                    <strong>@entry.Timestamp.ToLocalTime().ToString("hh:mm tt")</strong>
                    <span class="ms-2">@entry.ActionType</span>
                    <span class="ms-2 text-muted">by @entry.PerformedBy</span>
                    @if (!string.IsNullOrEmpty(entry.Notes))
                    {
                        <div class="ms-4 small text-secondary">@entry.Notes</div>
                    }
                    <a href="/Admin/DispatcherReplay?requestId=@entry.RequestId" class="btn btn-outline-info btn-sm mt-2">? Replay This Job</a>
                </li>
            }
        </ul>
    }
}
<style>
.timeline li { border-left: 2px solid #ccc; padding-left: 1em; position: relative; }
.timeline li span:first-child { position: absolute; left: -1.5em; top: 0; font-size: 1.2em; }
</style>
