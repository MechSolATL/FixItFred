@* Sprint 83: SmartControlUX upgrade *@
@page
@model Pages.Admin.StatsModel
@{
    ViewData["Title"] = "Admin Dashboard Metrics";
    var kpiList = new List<dynamic> // Sprint 83.1: Typed Razor array/list initialization
    {
        new { Label = "Total Requests", Value = Model.TotalRequests },
        new { Label = "Pending", Value = Model.PendingCount },
        new { Label = "Dispatched", Value = Model.DispatchedCount },
        new { Label = "Cancelled", Value = Model.CancelledCount },
        new { Label = "Completed", Value = Model.CompletedCount },
        new { Label = "Active Techs Today", Value = Model.ActiveTechsToday },
        new { Label = "GPS Updated", Value = Model.GpsUpdatedToday },
        new { Label = "Jobs Assigned", Value = Model.JobsAssignedToday },
        new { Label = "Avg ETA Accuracy", Value = Model.AvgEtaAccuracy },
        new { Label = "SignalR Broadcasts (24h)", Value = Model.SignalRBroadcasts24h }
    };
    // Sprint 83.4: Detection code removed to restore build stability
    // @using Wangkanai.Detection
    // @inject IDetectionService Detection
    // bool isMobile = Detection.Device.Type == DeviceType.Mobile;
    // bool isTablet = Detection.Device.Type == DeviceType.Tablet;
    // bool isDesktop = Detection.Device.Type == DeviceType.Desktop;
}
<!-- Sprint 83: SmartControlUX upgrade -->
<div class="container mx-auto px-2 py-4">
    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
        @foreach (var kpi in kpiList)
        {
            <div class="card bg-gradient-to-r from-gray-100 to-gray-300 shadow p-4 flex flex-col items-center">
                <div class="text-lg font-bold">@kpi.Label</div>
                <div class="text-2xl">@kpi.Value</div>
            </div>
        }
    </div>
    <button class="btn btn-primary mb-2" onclick="toggleSection('metricsChart')">Toggle Weekly Volume Chart</button>
    <div id="metricsChartSection" class="collapse show">
        <div class="row">
            <div class="col-md-12">
                <h4>Weekly ScheduleQueue Volume</h4>
                <canvas id="scheduleQueueChart" height="120"></canvas>
            </div>
        </div>
    </div>
</div>
<div class="row mb-4">
    <div class="col-md-12">
        <form method="post" asp-page-handler="GeneratePdfArchive" class="d-inline">
            <button type="submit" class="btn btn-outline-primary">
                <i class="bi bi-file-earmark-pdf"></i> Generate PDF Archive
            </button>
            @if (Model.PdfArchiveExists)
            {
                <a href="/@(Model.PdfArchivePath?.Replace("\\", "/") ?? "")" class="btn btn-success ms-2" download>
                    <i class="bi bi-download"></i> Download Sprint 44–46 PDF
                </a>
            }
            @if (!string.IsNullOrEmpty(Model.PdfArchiveError ?? "")) // Sprint 82: RazorViewFortification
            {
                <span class="text-danger ms-3">@Model.PdfArchiveError</span>
            }
        </form>
        <!-- Sprint 47 PDF Archive Button -->
        <form method="post" asp-page-handler="GenerateSprint47PdfArchive" class="d-inline ms-2">
            <button type="submit" class="btn btn-outline-warning">
                <i class="bi bi-file-earmark-pdf"></i> Generate Sprint 47 PDF Archive
            </button>
            @if (Model.Sprint47PdfArchiveExists)
            {
                <a href="/@(Model.Sprint47PdfArchivePath?.Replace("\\", "/") ?? "")" class="btn btn-success ms-2" download>
                    <i class="bi bi-download"></i> Download Sprint 47 PDF
                </a>
            }
            @if (!string.IsNullOrEmpty(Model.Sprint47PdfArchiveError ?? "")) // Sprint 82: RazorViewFortification
            {
                <span class="text-danger ms-3">@Model.Sprint47PdfArchiveError</span>
            }
        </form>
    </div>
</div>
@section Scripts {
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
    // Sprint 83: SmartControlUX upgrade
    function toggleSection(section) {
        var el = document.getElementById(section + 'Section');
        if (el.classList.contains('show')) {
            el.classList.remove('show');
            localStorage.setItem(section + 'Collapsed', 'true');
        } else {
            el.classList.add('show');
            localStorage.setItem(section + 'Collapsed', 'false');
        }
    }
    document.addEventListener('DOMContentLoaded', function() {
        var collapsed = localStorage.getItem('metricsChartCollapsed');
        var el = document.getElementById('metricsChartSection');
        if (collapsed === 'true' && el) el.classList.remove('show');
    });
    // Sprint 32.1 - Admin Metrics Reporting
    const weekLabels = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.WeekLabels ?? new List<string>())); // Sprint 82: RazorViewFortification
    const weekData = @Html.Raw(Newtonsoft.Json.JsonConvert.SerializeObject(Model.WeekCounts ?? new List<int>())); // Sprint 82: RazorViewFortification
    const ctx = document.getElementById('scheduleQueueChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: weekLabels,
            datasets: [{
                label: 'ScheduleQueue Volume',
                data: weekData,
                backgroundColor: '#0d6efd'
            }]
        },
        options: { plugins: { legend: { display: false } } }
    });
    // Real-time SignalR broadcast count update (optional, if endpoint exists)
    setInterval(function() {
        fetch('/api/admin/signalr-broadcasts-24h').then(r => r.json()).then(data => {
            document.getElementById('signalrCount').textContent = data.count;
        });
    }, 10000);
</script>
}
