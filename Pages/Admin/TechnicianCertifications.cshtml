@page
@model MVP_Core.Pages.Admin.TechnicianCertificationsModel
@using Data.Models
@inject MVP_Core.Services.CertificationService CertService
@{
    ViewData["Title"] = "Technician Certifications";
    var techId = Model.TechId;
    var certs = Model.Certifications;
    var expiredCerts = Model.ExpiredCerts;
}
<h2>Technician Certifications</h2>
<form method="get" class="mb-3">
    <label>Technician ID:</label>
    <input type="number" name="techId" value="@techId" />
    <button type="submit" class="btn btn-primary">View</button>
</form>
@if (certs.Count == 0)
{
    <div class="alert alert-info">No certifications found.</div>
}
else
{
    <form method="post" id="bulkActionsForm">
    <table class="table table-bordered">
        <thead>
            <tr>
                <th><input type="checkbox" id="selectAll" onclick="for(let cb of document.querySelectorAll('.bulk-cert')){cb.checked=this.checked}"></th>
                <th>Name</th>
                <th>License #</th>
                <th>Issue</th>
                <th>Expiry</th>
                <th>Status</th>
                <th>Document</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
        @foreach (var cert in certs)
        {
            string badgeIcon = cert.IsVerified && !cert.IsExpired ? "fa-check-circle text-success" :
                               (!cert.IsExpired && cert.DaysUntilExpiry <= 30 ? "fa-exclamation-circle text-warning" :
                               cert.IsExpired ? "fa-times-circle text-danger" : "fa-question-circle text-secondary");
            string badgeTooltip = cert.IsVerified && !cert.IsExpired ? "Verified & Valid" :
                                  (!cert.IsExpired && cert.DaysUntilExpiry <= 30 ? $"Expiring in {cert.DaysUntilExpiry} days" :
                                  cert.IsExpired ? "Expired" : "Pending Verification");
            <tr class="@(cert.IsExpired ? "table-danger" : cert.DaysUntilExpiry <= 30 ? "table-warning" : "")">
                <td><input type="checkbox" class="bulk-cert" name="selectedCertIds" value="@cert.Id" /></td>
                <td>@cert.CertificationName <i class="fas @badgeIcon" title="@badgeTooltip"></i></td>
                <td>@cert.LicenseNumber</td>
                <td>@(cert.IssueDate != DateTime.MinValue ? cert.IssueDate.ToString("d") : "-")</td>
                <td>@(cert.ExpiryDate.HasValue ? cert.ExpiryDate.Value.ToString("d") : "-") <span title="@badgeTooltip">@((cert.DaysUntilExpiry < int.MaxValue && !cert.IsExpired) ? $"({cert.DaysUntilExpiry} days left)" : "")</span></td>
                <td>@(cert.IsVerified ? "Verified" : cert.IsExpired ? "Expired" : "Pending")</td>
                <td>
                    @if (!string.IsNullOrEmpty(cert.DocumentPath))
                    {
                        <a href="@cert.DocumentPath" target="_blank">View</a>
                    }
                </td>
                <td>
                    @if (!cert.IsVerified)
                    {
                        <form method="post">
                            <input type="hidden" name="certId" value="@cert.Id" />
                            <button type="submit" class="btn btn-success btn-sm">Verify</button>
                        </form>
                    }
                </td>
            </tr>
        }
        </tbody>
    </table>
    <div class="mb-2">
        <button type="submit" formaction="?handler=BulkApprove" class="btn btn-success">Bulk Approve</button>
        <button type="submit" formaction="?handler=BulkReject" class="btn btn-danger">Bulk Reject</button>
        <button type="submit" formaction="?handler=ExportCsv" class="btn btn-secondary">Export to CSV</button>
    </div>
    </form>
}
@if (expiredCerts.Count > 0)
{
    <div class="alert alert-warning mt-3">
        <strong>Expired Certifications:</strong>
        <ul>
        @foreach (var cert in expiredCerts)
        {
            <li>@cert.CertificationName (Tech ID: @cert.TechnicianId) - Expired @(cert.ExpiryDate.HasValue ? cert.ExpiryDate.Value.ToString("d") : "-")</li>
        }
        </ul>
    </div>
}
<script src="https://kit.fontawesome.com/7c3b9e2e2a.js" crossorigin="anonymous"></script>
