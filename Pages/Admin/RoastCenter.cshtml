@page
@using Data.Models
@using Services.Admin
@inject RoastFeedbackService RoastFeedbackService
@model Pages.Admin.RoastCenterModel
@{
    ViewData["Title"] = "Roast Center";
}
<h2>Roast Center</h2>

<section>
    <h3>Roast Roulette Log</h3>
    <table class="table">
        <thead>
            <tr>
                <th>Employee</th>
                <th>Roast</th>
                <th>Tier</th>
                <th>Delivered At</th>
                <th>Feedback</th>
                <th>Legendary</th>
            </tr>
        </thead>
        <tbody>
        @foreach (var roast in Model.RoastRouletteLog)
        {
            var avgScore = RoastFeedbackService.CalculateAverageReactions(roast.Id).GetAwaiter().GetResult();
            var count = RoastFeedbackService.GetReactionCountAsync(roast.Id).GetAwaiter().GetResult();
            bool isLegendary = avgScore > 4.8 && count >= 10;
            <tr>
                <td>@roast.EmployeeId</td>
                <td>@roast.RoastMessage</td>
                <td>@((RoastTier)roast.RoastLevel)</td>
                <td>@roast.DeliveredAt?.ToString("g")</td>
                <td>
                    <form method="post" asp-page-handler="Feedback" asp-route-id="@roast.Id">
                        <span>Rate:</span>
                        <button name="reactionType" value="star1" type="submit" class="btn btn-light">??</button>
                        <button name="reactionType" value="star2" type="submit" class="btn btn-light">??</button>
                        <button name="reactionType" value="star3" type="submit" class="btn btn-light">??</button>
                        <button name="reactionType" value="star4" type="submit" class="btn btn-light">??</button>
                        <button name="reactionType" value="star5" type="submit" class="btn btn-warning">??</button>
                    </form>
                </td>
                <td>
                    @if (isLegendary)
                    {
                        <span class="badge bg-warning text-dark">Legendary ??</span>
                    }
                </td>
            </tr>
        }
        </tbody>
    </table>
    <form method="post" asp-page-handler="ManualRouletteDrop">
        <button type="submit" class="btn btn-primary">Trigger Manual Roast Roulette Drop</button>
    </form>
</section>

<section>
    <h3>Pending Roasts</h3>
    <table class="table">
        <thead>
            <tr>
                <th>Employee</th>
                <th>Roast</th>
                <th>Level</th>
                <th>Scheduled</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
        @foreach (var roast in Model.PendingRoasts)
        {
            <tr>
                <td>@roast.EmployeeId</td>
                <td>@roast.RoastMessage</td>
                <td>@(roast.RoastLevel == 1 ? "Light" : roast.RoastLevel == 2 ? "Medium" : "Savage")</td>
                <td>@roast.ScheduledFor.ToShortDateString()</td>
                <td>
                    <form method="post" asp-page-handler="Deliver" asp-route-id="@roast.Id">
                        <button type="submit" class="btn btn-danger">?? Hit 'Em!</button>
                    </form>
                </td>
            </tr>
        }
        </tbody>
    </table>
</section>

<section>
    <h3>Schedule a Roast</h3>
    <form method="post" asp-page-handler="Schedule">
        <div class="form-group">
            <label>Employee ID</label>
            <input type="text" name="EmployeeId" class="form-control" required />
        </div>
        <div class="form-group">
            <label>Roast Level</label>
            <select name="RoastLevel" class="form-control">
                <option value="1">Light</option>
                <option value="2">Medium</option>
                <option value="3">Savage</option>
            </select>
        </div>
        <button type="submit" class="btn btn-warning">Schedule Roast</button>
    </form>
</section>

<section>
    <h3>Roast Vault</h3>
    <table class="table">
        <thead>
            <tr>
                <th>Employee</th>
                <th>Roast</th>
                <th>Level</th>
                <th>Delivered At</th>
                <th>Badges</th>
            </tr>
        </thead>
        <tbody>
        @foreach (var roast in Model.PastRoasts)
        {
            <tr>
                <td>@roast.EmployeeId</td>
                <td>@roast.RoastMessage</td>
                <td>@(roast.RoastLevel == 1 ? "Light" : roast.RoastLevel == 2 ? "Medium" : "Savage")</td>
                <td>@roast.DeliveredAt?.ToString("g")</td>
                <td>
                    @if (roast.RoastTemplate?.LegacyStatus == true) { <span class="badge bg-warning">Legacy</span> }
                    @if (roast.RoastTemplate?.Retired == true) { <span class="badge bg-danger">Retired</span> }
                    @if (roast.RoastTemplate?.AIAuthored == true) { <span class="badge bg-info">AI</span> }
                </td>
            </tr>
        }
        </tbody>
    </table>
</section>

<section>
    <h3>RoastRank Leaderboard</h3>
    <table class="table">
        <thead>
            <tr>
                <th>Employee</th>
                <th>RoastRank Score</th>
            </tr>
        </thead>
        <tbody>
        @foreach (var kvp in Model.RoastRankScores.OrderByDescending(x => x.Value).Take(10))
        {
            <tr>
                <td>@kvp.Key</td>
                <td>@kvp.Value</td>
            </tr>
        }
        </tbody>
    </table>
</section>
