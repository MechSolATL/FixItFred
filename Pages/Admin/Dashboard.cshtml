@page
@model MVP_Core.Pages.Admin.DashboardModel
@inject global::Services.Dispatch.SlaDriftAnalyzerService SlaDriftAnalyzerService
@inject global::Services.Storage.StorageMonitorService StorageMonitorService
@inject global::Services.Admin.ComplianceReportService ComplianceReportService
@inject global::Services.Admin.SmartAdminAlertsService SmartAdminAlertsService
@{
    ViewData["Title"] = "Admin Dashboard";
    Layout = "~/Pages/Shared/_Layout.cshtml";
}

<div class="container mt-5">
    <h1 class="text-center mb-4">?? Service Requests Dashboard</h1>

    <!-- SLA Drift Heatmap Widget -->
    <div class="mb-4">
        <h4>SLA Drift Heatmap <span class="badge bg-warning">Live</span></h4>
        <div>@Model.SlaHeatmap</div>
    </div>

    <!-- Storage Growth Chart + Compress Now Button -->
    <div class="mb-4">
        <h4>Storage Growth <span class="badge bg-info">Live</span></h4>
        <div>@Model.StorageChart</div>
        <form method="post">
            <button type="submit" class="btn btn-secondary" formaction="/Admin/CompressStorage">Compress Now</button>
        </form>
    </div>

    <!-- Compliance Report Export Buttons -->
    <div class="mb-4">
        <h4>Compliance Reports</h4>
        <form method="post">
            <button type="submit" class="btn btn-outline-primary me-2" formaction="/Admin/ExportCompliance?type=pdf">Export PDF</button>
            <button type="submit" class="btn btn-outline-success" formaction="/Admin/ExportCompliance?type=csv">Export CSV</button>
        </form>
    </div>

    <!-- SmartAdminAlerts Bar + Icon Stack -->
    <div class="mb-4">
        <h4>Smart Admin Alerts</h4>
        @if (Model.ActiveAlerts.Any())
        {
            <div class="alert alert-warning d-flex flex-column">
                @foreach (var alert in Model.ActiveAlerts)
                {
                    <div class="d-flex align-items-center mb-2">
                        <span class="me-2"><i class="fas fa-exclamation-triangle"></i></span>
                        <span class="me-2">[@alert.Severity] @alert.Message</span>
                        <form method="post" asp-page-handler="AcknowledgeAlert" class="d-inline">
                            <input type="hidden" name="alertId" value="@alert.Id" />
                            <input type="hidden" name="actionTaken" value="Acknowledge" />
                            <button type="submit" class="btn btn-sm btn-success me-1">Acknowledge</button>
                        </form>
                        <form method="post" asp-page-handler="AcknowledgeAlert" class="d-inline">
                            <input type="hidden" name="alertId" value="@alert.Id" />
                            <input type="hidden" name="actionTaken" value="Mute" />
                            <button type="submit" class="btn btn-sm btn-secondary">Mute</button>
                        </form>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="alert alert-success">No active alerts.</div>
        }
        <div class="d-flex flex-row">
            <span class="me-2"><i class="fas fa-bell"></i></span>
            <span class="me-2"><i class="fas fa-bolt"></i></span>
            <span class="me-2"><i class="fas fa-shield-alt"></i></span>
        </div>
    </div>

    <!-- Escalation Alert Pill -->
    @if (Model.PendingEscalationCount > 0)
    {
        <div class="alert alert-danger d-flex align-items-center mb-3">
            <span class="me-2">??</span>
            <span><strong>@Model.PendingEscalationCount Tech Escalations Pending Review</strong></span>
        </div>
    }

    <!-- ?? Filters -->
    <div class="card mb-4 p-4 shadow-sm">
        <form method="get" class="row g-3 align-items-end">
            <div class="col-md-4">
                <label class="form-label">Filter by Service Type</label>
                <select name="ServiceType" class="form-select">
                    <option value="">All</option>
                    <option value="Plumbing">Plumbing</option>
                    <option value="Air Conditioning">Air Conditioning</option>
                    <option value="Water Filtration">Water Filtration</option>
                    <option value="Heating">Heating</option>
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label">Status</label>
                <select name="Status" class="form-select">
                    <option value="">All</option>
                    <option value="Pending">Pending</option>
                    <option value="Scheduled">Scheduled</option>
                    <option value="Completed">Completed</option>
                    <option value="Closed">Closed</option>
                </select>
            </div>
            <div class="col-md-4">
                <button type="submit" class="btn btn-primary w-100">?? Apply Filters</button>
            </div>
        </form>
    </div>

    <!-- ?? Requests Table -->
    <div class="table-responsive shadow-sm">
        <table class="table table-hover table-bordered align-middle">
            <thead class="table-dark text-center">
                <tr>
                    <th>Client</th>
                    <th>Service</th>
                    <th>Submitted</th>
                    <th>Status</th>
                    <th>Urgent</th>
                    <th>Needs Follow-Up</th>
                    <th>Phone</th>
                    <th>Email</th>
                    <th>Confirmed</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.ServiceRequests.Any())
                {
                    @foreach (var request in Model.ServiceRequests)
                    {
                        var urgentClass = request.IsUrgent ? "table-danger" : "";
                        var followUpClass = request.NeedsFollowUp ? "table-warning" : "";
                        var rowClass = $"{urgentClass} {followUpClass}".Trim();

                        <tr class="@rowClass">
                            <td>@request.CustomerName</td>
                            <td>@request.ServiceType</td>
                            <td>@request.CreatedAt.ToString("g")</td>
                            <td>
                                <span class="badge bg-@(request.Status == "Pending" ? "warning text-dark" : request.Status == "Scheduled" ? "info" : request.Status == "Completed" ? "success" : "secondary")">
                                    @request.Status
                                </span>
                            </td>
                            <td class="text-center">@(request.IsUrgent ? "??" : "-")</td>
                            <td class="text-center">@(request.NeedsFollowUp ? "??" : "-")</td>
                            <td>@request.Phone</td>
                            <td>@request.Email</td>
                            <td class="text-center">@(request.ClientConfirmedAt.HasValue ? "?" : "?")</td>
                            <td class="text-center">
                                <a href="/Admin/ViewRequest/@request.Id" class="btn btn-sm btn-primary mb-1">View</a><br />
                                @if (!request.ClientConfirmedAt.HasValue && request.Status != "Scheduled")
                                {
                                    <a href="/Admin/ConfirmRequest/@request.Id" class="btn btn-sm btn-warning mb-1">Confirm</a>

                                    <br />
                                }
                                @if (request.Status != "Closed")
                                {
                                    <a href="/Admin/CloseRequest/@request.Id" class="btn btn-sm btn-success">Close</a>
                                }
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="10" class="text-center text-muted p-4">
                            No service requests found.
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Feedback Spotlight Widget -->
    <div class="mb-3">
        <strong>Feedback Spotlight:</strong>
        <ul>
        @{
            var loyaltyDb = Model != null && Model.HttpContext != null ? Model.HttpContext.RequestServices.GetService(typeof(MVP_Core.Data.ApplicationDbContext)) as MVP_Core.Data.ApplicationDbContext : null;
            var reviews = loyaltyDb != null ? loyaltyDb.CustomerReviews.ToList() : new List<MVP_Core.Data.Models.CustomerReview>();
            var spotlight = reviews.OrderByDescending(r => r.SentimentScore ?? 0).FirstOrDefault();
            if (spotlight != null)
            {
                <li><b>Review #@spotlight.Id</b>: @spotlight.Feedback <span class="badge bg-info">Sentiment: @spotlight.SentimentScore</span></li>
            }
        }
        </ul>
    </div>

    <!-- Sync Champion Spotlight Widget -->
    <div class="mb-3">
        @using MVP_Core.Services.Admin
        @using MVP_Core.Data.Models
        @inject SyncIncentiveEngine SyncIncentiveEngine
        @await Html.PartialAsync("_SyncChampionSpotlight")
    </div>
</div>
