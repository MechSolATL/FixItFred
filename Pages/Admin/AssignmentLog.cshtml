@page
// FixItFred Patch Log — Sprint 25
// [2024-07-25T00:00:00Z] — Verified & corrected Razor structure and SEO injection.
@using MVP_Core.Models.Admin
@inject MVP_Core.Services.Admin.DispatcherService DispatcherService
@model MVP_Core.Pages.Admin.AssignmentLogModel
@{
    ViewData["Title"] = "Assignment Log";
    Layout = "/Pages/Shared/_Layout.cshtml";
    /*
    @inject ISEOService SEO
    <title>@SEO.Title</title>
    <meta name="description" content="@SEO.MetaDescription" />
    <meta name="keywords" content="@SEO.Keywords" />
    <meta name="robots" content="@SEO.Robots" />
    */
    var logs = DispatcherService.GetAssignmentLogs() ?? new List<AssignmentLogEntry>();
    string techFilter = (Request.Query["techId"].ToString() == "" ? "" : Request.Query["techId"].ToString());
    string dateFilter = (Request.Query["date"].ToString() == "" ? "" : Request.Query["date"].ToString());
    if (!string.IsNullOrEmpty(techFilter))
    {
        if (int.TryParse(techFilter, out var techId))
            logs = logs.Where(l => l.TechnicianId == techId).ToList();
    }
    if (!string.IsNullOrEmpty(dateFilter))
    {
        if (DateTime.TryParse(dateFilter, out var dt))
            logs = logs.Where(l => l.Timestamp.Date == dt.Date).ToList();
    }
    var safeValues = Model.AssignmentEntries?.Select(e => string.IsNullOrEmpty(e?.TechnicianName?.ToString()) ? "fallback" : e.TechnicianName.ToString()) ?? Enumerable.Empty<string>();
    var joinedNames = string.Join(", ", safeValues ?? new List<string>());
}
// FixItFred Patch Log — Sprint 24.9 Recovery Patch R24.9R [2024-07-24T23:20:00Z]
// Replaced model.Property ?? "fallback" with string.IsNullOrEmpty(model.Property.ToString()) ? "fallback" : model.Property.ToString() for TechnicianName.
<h2 class="mb-4">Assignment Log</h2>
<form method="get" class="mb-3 row g-2 align-items-end">
    <div class="col-md-3">
        <label class="form-label">Technician ID</label>
        <input type="number" name="techId" class="form-control" value="@techFilter" />
    </div>
    <div class="col-md-3">
        <label class="form-label">Date</label>
        <input type="date" name="date" class="form-control" value="@dateFilter" />
    </div>
    <div class="col-md-2">
        <button type="submit" class="btn btn-primary">Filter</button>
    </div>
</form>
<table class="table table-bordered table-hover">
    <thead class="table-light">
        <tr>
            <th>Request ID</th>
            <th>Technician ID</th>
            <th>Dispatcher</th>
            <th>Score</th>
            <th>Tier</th>
            <th>Tags</th>
            <th>Rationale</th>
            <th>Timestamp</th>
        </tr>
    </thead>
    <tbody>
    @if (logs == null || !logs.Any())
    {
        <tr><td colspan="8" class="text-center text-muted">No assignment logs found.</td></tr>
    }
    else
    {
        @foreach (var log in logs)
        {
            <tr>
                <td>@log.RequestId</td>
                <td>@log.TechnicianId</td>
                <td>@log.DispatcherName</td>
                <td>@log.DispatchScore</td>
                <td>@log.Tier</td>
                <td>@string.Join(", ", log.MatchedTags)</td>
                <td>@log.Rationale</td>
                <td>@log.Timestamp.ToLocalTime().ToString("g")</td>
            </tr>
        }
    }
    </tbody>
</table>
