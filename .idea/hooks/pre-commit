#!/bin/bash
# [OmegaSweep_Auto] Pre-commit hook for local validation
# Validates empathy tests and build integrity before allowing commits

echo "[OmegaSweep_Auto] Running pre-commit validation..."

# Create logs directory if it doesn't exist
mkdir -p Logs

# Initialize log file
echo "[OmegaSweep_Auto] Pre-commit validation started at $(date)" >> Logs/Revitalize_OmegaSweep_Log.md

# Check if this is a commit affecting Omega Sweep relevant files
CHANGED_FILES=$(git diff --cached --name-only)
RELEVANT_CHANGES=$(echo "$CHANGED_FILES" | grep -E "(Revitalize/|Tools/|Tests/|CLI/)")

if [ -z "$RELEVANT_CHANGES" ]; then
    echo "[OmegaSweep_Auto] No Omega Sweep relevant files changed, skipping validation"
    exit 0
fi

echo "[OmegaSweep_Auto] Relevant files changed: $RELEVANT_CHANGES" >> Logs/Revitalize_OmegaSweep_Log.md

# Build validation
echo "[OmegaSweep_Auto] Running build validation..."
if ! dotnet build --configuration Release > /dev/null 2>&1; then
    echo "[OmegaSweep_Auto] Build failed - commit blocked" >> Logs/Revitalize_OmegaSweep_Log.md
    echo "❌ [OmegaSweep_Auto] Build validation failed. Commit blocked."
    echo "   Run 'dotnet build' to see detailed errors."
    exit 1
fi

echo "[OmegaSweep_Auto] Build validation passed" >> Logs/Revitalize_OmegaSweep_Log.md

# Empathy tests validation
echo "[OmegaSweep_Auto] Running empathy tests..."
if ! dotnet test --filter "Category=Empathy" --logger "console;verbosity=quiet" > /dev/null 2>&1; then
    echo "[OmegaSweep_Auto] Empathy tests failed - commit blocked" >> Logs/Revitalize_OmegaSweep_Log.md
    echo "❌ [OmegaSweep_Auto] Empathy test validation failed. Commit blocked."
    echo "   Run 'dotnet test --filter \"Category=Empathy\"' to see detailed results."
    exit 1
fi

echo "[OmegaSweep_Auto] Empathy tests passed" >> Logs/Revitalize_OmegaSweep_Log.md

# DI conflict check
echo "[OmegaSweep_Auto] Checking for DI conflicts..."
if grep -n "AddScoped.*Services\." Program.cs | sort | uniq -d | wc -l | grep -v "^0$" > /dev/null; then
    echo "[OmegaSweep_Auto] DI conflicts detected - commit blocked" >> Logs/Revitalize_OmegaSweep_Log.md
    echo "❌ [OmegaSweep_Auto] DI conflicts detected. Commit blocked."
    echo "   Check Program.cs for duplicate service registrations."
    exit 1
fi

echo "[OmegaSweep_Auto] No DI conflicts detected" >> Logs/Revitalize_OmegaSweep_Log.md

echo "[OmegaSweep_Auto] Pre-commit validation completed successfully at $(date)" >> Logs/Revitalize_OmegaSweep_Log.md
echo "✅ [OmegaSweep_Auto] All validations passed. Commit allowed."
exit 0